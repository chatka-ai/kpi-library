id: gross_margin
display_name: Gross Margin (%)
domain: Finance
category: Profitability
aliases: ["GM%", "margin"]
description: Gross margin percentage = (Revenue - COGS) / Revenue.
grain: month
dimensions:
  - { name: date, semantic: temporal }
  - { name: product_category, semantic: product_hierarchy }
  - { name: region, semantic: geography }
  - { name: channel, semantic: sales_channel }
derived_from: []
business_rules:
  revenue_floor: 1.0
formula:
  expression: "SAFE_DIVIDE(SUM(revenue) - SUM(cogs), NULLIF(SUM(revenue), 0))"
  notes: "Use SAFE_DIVIDE to avoid division by zero; filter returns if needed."
sql:
  bigquery:
    source_table: your_project.finance.facts_pnl
    metric_view: your_project.analytics_mv.gross_margin_monthly
    params: ["@start_date", "@end_date"]
    query: |
      SELECT
        DATE_TRUNC(date, MONTH) AS month,
        region, channel, product_category,
        SAFE_DIVIDE(SUM(revenue) - SUM(cogs), NULLIF(SUM(revenue), 0)) AS gross_margin_pct
      FROM `your_project.finance.facts_pnl`
      WHERE date BETWEEN @start_date AND @end_date
      GROUP BY 1,2,3,4
tests:
  - name: margin_bounds
    assertion: "gross_margin_pct BETWEEN -0.5 AND 0.9"
examples:
  business_questions:
    - "Which region saw margin compression vs last quarter?"
    - "Which category-channel combos improved margin despite discounts?"
demo:
  seed_data: seeds/finance/finance_facts.sample.csv

